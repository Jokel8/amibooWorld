<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Map Renderer</title>
    <link rel="stylesheet" href="css/style.css?v=1">
</head>

<body>
    <p style="display: none;">Wenn die Map nicht reagiert, drücke Sie ein Mal an</p>

    <div id="mapGrid">
    </div>

    <script>
        var width;
        var height;
        var blockSize;
        var middle;
        const steps = [];

        var originX;
        var originY;

        var crosshair;
        var character;
        var mapElement;
        let crosshairX;
        let crosshairY;

        let absoluteX;
        let absoluteY;

        function darkenTile(x, y) {
            const tiles = mapElement.children;
            const index = y * width + x + 1;
            if (tiles[index]) {
                tiles[index].style.filter = 'brightness(50%)';
            }
        }

        function updateCrosshair() {
            crosshair.style.transform = `translate(${crosshairX * (blockSize + 2)}px, ${crosshairY * (blockSize + 2)}px)`;
            steps.push({ x: absoluteX, y: absoluteY });
            console.log(`Moved to: (${absoluteX}, ${absoluteY})`);
        }

        async function updateActions() {
            await fetch('user_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'get',
                    token: token,
                    get: "thingsAtPosition",
                    x: absoluteX,
                    y: absoluteY
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log(data);
                        if (data.users) {
                            document.getElementById('buttonAngreifen').classList.remove('deactivated');
                        } else {
                            document.getElementById('buttonAngreifen').classList.add('deactivated');
                        }

                        var onBuilding = false;
                        for (let field of data.fields) {
                            if (field.field_type > 99) {
                                onBuilding = field.field_type;
                            }
                        }

                        const buttonBauen = document.getElementById('buttonBauen');
                        if (!onBuilding) {
                            buttonBauen.classList.remove('deactivated');
                            buttonBauen.innerHTML = "Haus bauen";
                        } else {
                            if(onBuilding === 104) {
                                buttonBauen.classList.add('deactivated');
                            }
                            buttonBauen.innerHTML = "Haus erweitern";
                        }
                    } else {
                        console.log('Abfrage fehlgeschlagen. ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Fehler:', error);
                });
        }

        function eventListener(event) {
            const prevX = crosshairX;
            const prevY = crosshairY;

            if (event.key === 'w' && crosshairY > 0) {
                const targetTile = mapElement.children[(crosshairY - 1) * width + crosshairX + 1];
                if (targetTile && targetTile.classList.contains('walkable')) {
                    crosshairY--; // Nach oben bewegen
                    absoluteY++;
                }
            } else if (event.key === 's' && crosshairY < height - 1) {
                const targetTile = mapElement.children[(crosshairY + 1) * width + crosshairX + 1];
                if (targetTile && targetTile.classList.contains('walkable')) {
                    crosshairY++; // Nach unten bewegen
                    absoluteY--;
                }
            } else if (event.key === 'a' && crosshairX > 0) {
                const targetTile = mapElement.children[crosshairY * width + (crosshairX - 1) + 1];
                if (targetTile && targetTile.classList.contains('walkable')) {
                    crosshairX--; // Nach links bewegen
                    absoluteX--;
                }
            } else if (event.key === 'd' && crosshairX < width - 1) {
                const targetTile = mapElement.children[crosshairY * width + (crosshairX + 1) + 1];
                if (targetTile && targetTile.classList.contains('walkable')) {
                    crosshairX++; // Nach rechts bewegen
                    absoluteX++;
                }
            } else if (event.key === 'o') {
                changeAktionen('agieren');
            } else if (event.key === 'p') {
                changeAktionen('profil');
            } else if (event.key === 'i') {
                changeAktionen('inventar');
            }

            if (prevX !== crosshairX || prevY !== crosshairY) {
                darkenTile(prevX + 1, prevY);
                updateCrosshair();
                updateActions();
            }
        }

        async function loadCharacter(token) {
            await fetch('user_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'get',
                    token: token,
                    get: "character"
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        console.log("Character:" + data.character);
                        document.getElementById("character").src = "../CMS/getAsset.php?action=getImg&type=character&id=" + data.character;
                    } else {
                        console.log('Abfrage fehlgeschlagen. ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Fehler:', error);
                });
        }

        async function renderMap() {
            await fetch('user_data.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    action: 'get',
                    token: token,
                    get: "position"
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        originX = data.x;
                        originY = data.y;
                        absoluteX = originX;
                        absoluteY = originY;
                        //console.log(data.x, "-", data.y);
                    } else {
                        console.log('Abfrage fehlgeschlagen. ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Fehler:', error);
                });

            const response = await fetch('https://v2202410237002289383.megasrv.de/map?x=' + originX + '&y=' + originY + '&r=4');
            const mapData = await response.json();
            console.log(mapData)

            height = mapData.height;
            width = mapData.width;
            middle = (width - 1) / 2;

            if (window.innerWidth < 750) {
                blockSize = 25;
            } else if (window.innerWidth < 865) {
                blockSize = 38;
            } else if (window.innerWidth < 1100) {
                blockSize = 55;
            } else if (window.innerWidth < 1375) {
                blockSize = 65;
            } else {
                blockSize = 100;
            }

            mapElement = document.getElementById('mapGrid');
            mapElement.innerHTML = ""; // Lösche den alten Inhalt des Elements

            //Character:
            character = document.createElement('img');
            character.id = 'character';
            character.style.width = `${blockSize}px`;
            character.style.height = `${blockSize}px`;
            character.style.transform = `translate(${middle * (blockSize + 2)}px, ${middle * (blockSize + 2)}px)`;
            mapElement.appendChild(character);
            loadCharacter(token);

            crosshair = document.createElement('div');
            crosshair.id = 'crosshair';
            crosshair.style.width = `${blockSize}px`;
            crosshair.style.height = `${blockSize}px`;
            mapElement.appendChild(crosshair);
            crosshairX = middle;
            crosshairY = middle;
            updateCrosshair();

            mapElement.style.gridTemplateColumns = `repeat(${width}, ${blockSize}px)`;
            mapElement.style.gridTemplateRows = `repeat(${height}, ${blockSize}px)`;

            document.removeEventListener('keydown', eventListener)
            document.addEventListener('keydown', eventListener);

            const layers = [];

            // Find the maximum x and y values to define the map dimensions
            const maxX = Math.max(...mapData.map.map(tile => tile.x));
            const maxY = Math.max(...mapData.map.map(tile => tile.y));

            // Initialize the layers as a 2D array (with y axis flipped)
            for (let i = 0; i <= maxY; i++) {
                layers[i] = [];
                for (let j = 0; j <= maxX; j++) {
                    layers[i][j] = [];
                }
            }

            // Fill the 2D array with tiles from the mapData
            mapData.map.forEach((tile) => {
                const invertedY = maxY - tile.y;
                layers[invertedY][tile.x].push(tile);
            });

            layers.forEach((row, y) => {
                row.forEach((tileLayers, x) => {
                    if (tileLayers.length === 0) return;

                    const tileContainer = document.createElement('div');
                    tileContainer.classList.add('tile');

                    tileLayers.forEach((tileData, index) => {
                        const tileLayer = document.createElement('div');
                        tileLayer.classList.add('tile-layer');

                        tileLayer.style.backgroundImage = 'url(../CMS/getAsset.php?action=getImg&type=field_type&id=' + tileData.properties.value + ')';
                        tileLayer.style.zIndex = index;
                        tileLayer.textContent = tileData.properties.value;

                        // Cursor und Interaktivität basierend auf Begehbarkeit
                        if (tileData.properties.is_walkable) {
                            tileContainer.classList.add('walkable');
                        } else {
                            tileContainer.classList.add('not-walkable');
                        }

                        tileContainer.appendChild(tileLayer);

                        // Ressourcen-Icons
                        const resourcesDiv = document.createElement('div');
                        resourcesDiv.classList.add('resources');

                        if (tileData.resources.holz > 0) {
                            const woodIcon = document.createElement('i');
                            woodIcon.classList.add('tree', 'text-green-500');
                            woodIcon.title = `Holz: ${tileData.resources.holz}`;
                            resourcesDiv.appendChild(woodIcon);
                        }

                        if (tileData.resources.gold > 0) {
                            const goldIcon = document.createElement('i');
                            goldIcon.classList.add('gold', 'text-yellow-500');
                            goldIcon.title = `Gold: ${tileData.resources.gold}`;
                            resourcesDiv.appendChild(goldIcon);
                        }

                        tileContainer.appendChild(resourcesDiv);
                    });

                    mapElement.appendChild(tileContainer);
                });
            });

        }

        renderMap();
    </script>
</body>

</html>